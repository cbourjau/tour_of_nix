<!DOCTYPE html>
<html lang="en" dir="ltr" >
<head>
  <meta name="http-equiv" content="Content-type: text/html; charset=UTF-8"/>
  <link rel='shortcut icon' type='image/x-icon' href='favicon.ico' />

  <!--[if IE]>
  <meta HTTP-EQUIV="REFRESH" content="0; url=https://www.mozilla.org/en-US/firefox/new/">
  <![endif]-->


  <!--
  -->
  <script type="text/javascript" src="nix-instantiate.js"></script>
  <script type="text/javascript" src="markdown.min.js"></script>
  <script type="text/javascript" src="FileSaver.min.js"></script>
  <title>A tour of Nix</title>

  <link rel="stylesheet" href="codemirror-5.5/lib/codemirror.css">
  <link rel="stylesheet" href="style.css" type="text/css"/>
  <link id ="styleMobile" rel="stylesheet" href="style_mobile.css" type="text/css"/>
  <link rel="stylesheet" href="font/font.css" type="text/css"/>
  <script type="text/javascript" src="codemirror-5.5/lib/codemirror.js"></script>
  <script type="text/javascript" src="codemirror-5.5/mode/shell/shell.js"></script>

  <script type="text/javascript" charset="utf-8">

var initialized = 0;
var selected_question = 0;

var saveQuestions = function() {
  var t = questions;
  t.questions[selected_question].solution = document.getElementById("solution").value;
  
  for (i = 0; i < t.questions.length; i++) {
    delete t.questions[i].mycode;
    t.questions[i].result = "";
  }
  var questionsJSON = JSON.stringify(t, null, 4)
  var blob = new Blob([questionsJSON], {type: "text/plain;"});
  
  saveAs(blob, "questions.json");
  delete t;
}

var prepare_data = function () {
  for(i = 0; i < questions.questions.length; i++) {
    questions.questions[i].mycode = questions.questions[i].code;
  }
}
var auto_resize = function (e) {
  //e.rows=e.value.split('\n').length+2
  
  e.style.height = 'auto';
  e.style.height = e.scrollHeight + 2 +'px';
}
function getURLParameter(name) {
  return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
}
function load_wanted_page() {
  var i = parseInt(getURLParameter("id"))
    //console.log("parser of getURLParameter found: " + getURLParameter("id"))
    //console.log("parser of getURLParameter found: " + i)
    if (!isNaN(i)) {
      change_question(i-1) 
    } else {
      change_question(0) 
    }
}
var keys = [];
function keysPressed(e) {
  keys[e.keyCode] = true;
  if (keys[16] && keys[13]) { // shift+return
    runNix()
      e.preventDefault(); 
  }
  if (keys[17] && keys[74]) { // ctrl+ k
    change_question(1);
    e.preventDefault(); 
  }
  if (keys[17] && keys[75]) { // ctrl+.j
    change_question(-1);
    e.preventDefault(); 
  }
  if (keys[17] && keys[190]) { // ctrl+.
    markdown2html();
    e.preventDefault(); 
  }
  if (keys[17] && keys[188]) { // ctrl+,
    load_markdown();
    e.preventDefault(); 
  }
  if (keys[17] && keys[73]) { // ctrl+i
    reset_question();
    e.preventDefault(); 
  }
  if (keys[17] && keys[83]) { // ctrl+i
    saveQuestions();
    e.preventDefault(); 
  }
}
function keysReleased(e) {
  // mark keys that were released
  keys[e.keyCode] = false;
}
window.addEventListener("keydown", keysPressed, false);
window.addEventListener("keyup", keysReleased, false);

var questions;
var current_question = 0;

function loadJSON(path, success, error) {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function()
  {
    if (xhr.readyState === XMLHttpRequest.DONE) {
      if (xhr.status === 200) {
        if (success)
          success(JSON.parse(xhr.responseText));
      } else {
        if (error)
          error(xhr);
      }
    }
  };
  xhr.open("GET", path, true);
  xhr.send();
}
loadJSON('questions.json',
    function(data) { /*console.log(data);*/ questions = data; prepare_data(); load_wanted_page();},
    function(xhr) { console.error(xhr); }
    );

var change_question = function(myinput) {
  // save old state
  var output = document.getElementById('output');
  output.style.backgroundColor = "grey";

  if (initialized) {
    questions.questions[current_question].mycode = editor.getValue();
    questions.questions[current_question].result = output.value;
    auto_resize(output)
  }
  initialized=1;
  current_question += myinput; 

  if (current_question < 0)
    current_question = 0;
  if (current_question >= questions.questions.length-1)
    current_question = questions.questions.length-1;

  window.history.pushState('', '',  window.location.pathname + '?id=' + (current_question + 1));

  var contentTitle = document.getElementById('contentTitle');
  var contentText = document.getElementById('contentText');
  var contentSolution = document.getElementById('solution');

  var topic = questions.questions[current_question].topic;
  var question = questions.questions[current_question].question;
  var mycode = questions.questions[current_question].mycode;
  var solution = questions.questions[current_question].solution;
  contentSolution.style.display="none";

  contentTitle.innerHTML = String(current_question + 1 + " - " + topic);
  contentText.innerHTML = markdown.toHTML(question);
  contentSolution.value = solution;
  auto_resize(contentSolution);
  editor.setValue(mycode);
  if (typeof(questions.questions[current_question].result) !== "undefined")
    output.value = questions.questions[current_question].result;
  else
    output.value = "";
  auto_resize(output);
  auto_resize(contentSolution);
  selected_question = current_question;

  //var str = window.location.search
  //replaceQueryParam('id', current_question+1, str)
  //console.log(window.location.pathname + str)
  //window.location = window.location.pathname + str
};

flipStylesheet = function() {
    document.getElementById("styleMobile").disabled = !document.getElementById("styleMobile").disabled;
  }

var showSolution = function() {
  var s = document.getElementById('solution');
  
  if (s.style.display == "none") {
    s.style.display = "flex";
    auto_resize(s);
  } else {
    s.style.display = "none";
  }
}
var reset_question = function() {
  editor.setValue(questions.questions[selected_question].code);
  
  var output = document.getElementById('output');
  output.style.backgroundColor = "grey";
  console.log("reset question")
}
var markdown2html = function() {
  var text = editor.getValue();
  if (text == questions.questions[selected_question].question) {
    // qutting the editor
    editor.setValue(questions.questions[selected_question].mycode);
  } else {
    // changes were detected, so we just update the preview
    contentText.innerHTML = markdown.toHTML(text);
    questions.questions[selected_question].question = text;
  }
}
var load_markdown = function() {
  var text = questions.questions[current_question].question;
  editor.setValue(text.split('\\n').join('\n').replace("\\\"", "\""))
}
var runNix = function() {
  // run the solution
  
  var correct_solution;
  
  Module['print'] = function(text) {
    Module['return'] = text + '\n'; 
    correct_solution = text;
  };
  Module['printErr'] = function(text) {
  //this should not happen
  //TODO exception handling
  };
  var solution_text = questions.questions[current_question].solution;
  FS.writeFile('/test.nix', solution_text, {encoding: 'utf8'});
  Module['arguments'] = ['-I', 'nixpkgs=nixpkgs', '--eval', '--strict', '--show-trace', '/test.nix'];
  //var result = FS.readFile('test.nix', {encoding: 'utf8'});
  //console.log(result);
  Module.callMain(Module['arguments']);
  
  
  
  //run the user input
  console.log("running runNix()");
  document.getElementById('runInfo').innerHTML = "computation in progress";
  document.getElementById('output').value = "";
  Module['print'] = function(text) {
    Module['return'] = text + '\n'; 
    var o = document.getElementById('output');
    if (text == correct_solution){
      console.log("correct answer");
      o.value += text;
      o.style.backgroundColor = "#44aa44";
  //    setTimeout(function () {o.style.backgroundColor = "grey"}, 2000);
    }else{
      console.log("incorrect answer");
      o.value += "your solution:\n" + text + "\nexpected was:\n" + correct_solution;
      o.style.backgroundColor = "#aa4444";
  //    setTimeout(function () {o.style.backgroundColor = "grey"}, 2000); 
    }
    auto_resize(o);
    document.getElementById('runInfo').innerHTML = "";
        
  };
  Module['printErr'] = function(text) {
    text = text.replace("[31;1m", "");
    text = text.replace("[1m", "");
    text = text.replace("[1m", "");
    text = text.replace("[0m","");
    text = text.replace("[0m","");
    text = text.replace("/test.nix","line");
    text = text.replace("/test.nix","line");
    text = text.replace("/test.nix","line");
    text = text.replace("/test.nix","line");
    text = text.replace(//g, "");
    console.log(text);
    Module['return'] = text + '\n'; 
    document.getElementById('runInfo').innerHTML = "";
    var o = document.getElementById('output')
      o.value += text;
    auto_resize(o)
    
    console.log("incorrect answer");
    o.value += text;
    o.style.backgroundColor = "#aa4444";
//    setTimeout(function () {o.style.backgroundColor = "grey"}, 2000);
  };
  var input_text = editor.getValue();
  FS.writeFile('/test.nix', input_text, {encoding: 'utf8'});
  Module['arguments'] = ['-I', 'nixpkgs=nixpkgs', '--eval', '--strict', '--show-trace', '/test.nix'];
  //var result = FS.readFile('test.nix', {encoding: 'utf8'});
  //console.log(result);
  Module.callMain(Module['arguments']);
};   	    

  </script>
</head>
<body>
  <div id="spinner" class="spinner-flex-container-row">
    <div class="spinner-flex-container-col">
      <div id="spinner-icon"><img src="nix.gif"></div>
      <div id="status">Downloading...</div>
      <progress value="0" max="100" id="progress" hidden=1>progress</progress>
    </div>
  </div>
  <div class="flex-container-col">
    <div id="h_container" class="flex-container-row">
      <div id="header"><h1>A tour of Nix</h1></div>
      <div id="rotate" onclick="flipStylesheet()"></div>
    </div>
    <div id="middle" class="flex-container-row">
      <div id="left" class="flex-container-col">
        <div id="adsfas" class="flex-container-col">
          <textarea class="input" id="input" rows="8">demo text textarea</textarea>
          <div id="editorButtonGroup"  class="flex-container-row">
            <button type="button" class="myButton" id="resetButton" onClick="reset_question()" title="">reset</button>
            <button type="button" class="myButton" id="solutionButton" onClick="showSolution()" title="">solution</button>
            <button type="button" class="myButton" id="runButton" onClick="runNix()" title="use shift+return">run</button>
          </div>
        </div>
        <textarea id="output" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
        <textarea id="solution" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
        <div id="runInfo"></div>
      </div>
      <div id="right" class="flex-container-col">
        <div id="questionNavigation" class="flex-container-row">
          <button type="button" class="myButton" id="prevButton" title="use ctrl+k" onClick="change_question(-1)" >prev</button>
          <button type="button" class="myButton" id="nextButton" title="use ctrl+j" onClick="change_question(1)" >next</button>
        </div>
        <h1><div id="contentTitle">A tour of Nix</div></h1>
        <div id="contentText">If you can see this, questions.json wasn't loaded properly!</div>
      </div>
    </div>
  </div>
  <div id="footerFG"> </div>
  <div id="footerBG"><img src="footerBG.jpg" width="100%" height="100%"/></div>
  <script type="text/javascript">
var input = document.getElementById('input');
var editor = CodeMirror.fromTextArea(input, {
  lineNumbers: true,
  viewportMargin: Infinity,
});
  </script>
</body>
</html>
